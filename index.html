<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Document</title>
		<link rel="stylesheet" type="text/css" href="css/styles.css">
        <script type="text/javascript" src="js/utils/logger.js"></script>
        <script type="text/javascript" src="js/lib/alerts.js"></script>
		<script src="js/lib/jquery.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript" src="js/config.js"></script>
		<script type="text/javascript" src="js/components/creator.js"></script>
		<script type="text/javascript" src="js/utils/GVector2f.js"></script>
		<script type="text/javascript" src="js/utils/utils.js"></script>
		<script type="text/javascript" src="js/components/menu.js"></script>
		<script type="text/javascript" src="js/components/slider.js"></script>
		<script type="text/javascript" src="js/components/contextMenu.js"></script>
        <script type="text/javascript" src="js/components/fileManager.js"></script>
		<script type="text/javascript" src="js/components/input.js"></script>
        <script type="text/javascript" src="js/components/contentManager.js"></script>
		<script type="text/javascript" src="js/components/selectedObjects.js"></script>
		<script type="text/javascript" src="js/components/layer.js"></script>
		<script type="text/javascript" src="js/components/scene.js"></script>
        <script type="text/javascript" src="js/components/timeLine.js"></script>
        <script type="text/javascript" src="js/components/projectManager.js"></script>
        <script type="text/javascript" src="js/components/paintManager.js"></script>
		<script type="text/javascript" src="js/listeners.js"></script>
		<script type="text/javascript" src="js/main.js"></script>
		<script type="text/javascript" src="js/canvas.js"></script>
		<script type="text/javascript" src="js/objects/entity.js"></script>
		<script type="text/javascript" src="js/components/layersViewer.js"></script>
        <script type="text/javascript" src="js/components/creatorViewer.js"></script>
		<script type="text/javascript" src="js/objects/text.js"></script>
		<script type="text/javascript" src="js/objects/table.js"></script>
		<script type="text/javascript" src="js/objects/class.js"></script>
		<script type="text/javascript" src="js/objects/polygon.js"></script>
		<script type="text/javascript" src="js/objects/join.js"></script>
		<script type="text/javascript" src="js/objects/rect.js"></script>
		<script type="text/javascript" src="js/objects/paint.js"></script>
		<script type="text/javascript" src="js/objects/line.js"></script>
		<script type="text/javascript" src="js/objects/arc.js"></script>
        <script type="text/javascript" src="js/objects/imageObject.js"></script>
		<script type="text/javascript" src="js/objects/arrow.js"></script>
		<script type="text/javascript" src="js/utils/test.js"></script>
		<script type="text/javascript" src="js/components/sharer.js"></script>
        <script type="text/javascript" src="js/components/taskManager.js"></script>

		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no" />
		<meta name="apple-mobile-web-app-copable" content="yes">
	</head>
	<body>
		<div id="modalWindow" class="hide">
			<div id="colorPalete" class="hide"></div>
            <div id="shareForm" class="hide formContent">
                <form>
                    <h2>Sharing options</h2>
                    <br/>
                    <div>
                        <label for="idMaxWatchers">Maximálny počet watcherov: </label>
                        <input id="idMaxWatchers" type="number" value="20" name="maxWatchers">
                    </div>

                    <div>
                        <label for="idSharingPassword">Heslo: </label>
                        <input id="idSharingPassword" type="password" name="sharingPassword">
                    </div>

                    <div class="panel">
                        <label for="idRealtimeSharing">Realtime zdielatie: </label>
                        <input id="idRealtimeSharing" type="checkbox" checked name="realtimeSharing">
                    </div>

                    <div class="panel">
                        <label for="idDetailMovement">Odosielať podrobný pohyb: </label>
                        <input id="idDetailMovement" type="checkbox" checked name="detailMovement">
                    </div>

                    <div class="panel">
                        <div>Čo zdielať:</div>
                        <div>
                            <div>
                                <input type="checkbox" id="idShareMenu" name="shareMenu">
                                <label for="idShareMenu">Menu</label>
                            </div>
                            <div>
                                <input type="checkbox" id="idSharePaints" name="sharePaints">
                                <label for="idSharePaints">Kresby</label>
                            </div>
                            <div>
                                <input type="checkbox" id="idShareObjects" name="shareObjects">
                                <label for="idShareObjects">Objekty</label>
                            </div>
                        </div>
                    </div>
                    <div class="panel">
                        <input type="button" value="Začať zdielanie" onclick="serializeShareData()">
                    </div>
                </form>
            </div>
            <div id="optionsForm" class="hide formContent">
                <form>
                    <h2>Options</h2>
                    <br/>
                    <div>
                        <label for="idAllowedSnapping">Prichytávanie: </label>
                        <select name="allowedSnapping" id="idAllowedSnapping">
                            <option value="none" selected>Žiadne</option>
                            <option value="90">90 stupnov</option>
                            <option value="45">45 stupnov</option>
                            <option value="30">30 stupnov</option>
                        </select>
                    </div>
                    <div class="panel">
                        <label for="idShowGrid">Zobraziť mriežku: </label>
                        <input id="idShowGrid" type="checkbox" checked name="showGrid">
                    </div>
                    <div class="panel">
                        <label for="idShowLayersViewer">Zobraziť správcu vrstiev: </label>
                        <input id="idShowLayersViewer" type="checkbox" checked name="showLayersViewer">
                    </div>
                    <input type="button" value="Použiť nastavenia" onclick="serializeOptionsData()">
                </form>
            </div>
            <div id="saveForm" class="hide formContent">
                <form>
                    <h2>Saving options</h2>
                    <br/>
                    <div>
                        <label for="idImageName">Názov súboru: </label>
                        <input id="idImageName" type="text" placeholder="desktopScreen" name="imageName">
                    </div>
                    <div>
                        <label for="idImageFormat">Formát: </label>
                        <select name="imageFormat" id="idImageFormat">
                            <option value="" disabled selected>Vyber</option>
                            <option value="image/jpeg">JPG</option>
                            <option value="image/png">PNG</option>
                            <option value="image/gif">GIF</option>
                        </select>
                    </div>
                    <div>
                        <label for="idImageWidth">Width:</label>
                        <input type="number" id="idImageWidth" value="800">
                        <label for="idImageHeight">Height:</label>
                        <input type="number" id="idImageHeight" value="600">
                    </div>
                    <div class="panel">
                        <div>Vrstvy:</div>
                        <div id="layersSavionOptions">

                        </div>
                    </div>
                    <!--<input type="button" value="Uložiť obrázok" onclick="processAndSaveImage()">-->
                    <input type="button" value="Uložiť obrázok" onclick="serializeSaveData()">
                </form>
            </div>
		</div>
        <div id="content">
            <img id="contentImage" src="#" class="hide">
            <div id="contentHTML" class="hide"></div>
        </div>
		<canvas class="canvas animated" id="myCanvas">
            Váš prehliadač nepodporuje Canvas
		</canvas>
        <input id="fileInput" type="file" value="files" class="hide">
        <a href="" class="hide" id="fileLink"></a>
	</body>
</html>
<script>
    var colors = ["#191919", "#DFE2DB", "#FFF056", "#FFFFFF", "#C63D0F", "#3B3738", "#FDF3E7",
                  "#7E8F7C", "#005A31", "#A8CD1B", "#CBE32D", "#F3FAB6", "#558C89", "#74AFAD",
                  "#D9853B", "#ECECEA", "#2B2B2B", "#DE1B1B", "#F6F6F6", "#E9E581", "#7D1935",
                  "#4A96AD", "#F5F3EE", "#E44424", "#67BCDB", "#A2AB58", "#404040", "#6DBDD6",
                  "#B71427", "#FFE658", "#585858", "#118C4E", "#C1E1A6", "#FF9009", "#DF3D82",
                  "#F361C2", "#EBED5B", "#3C007B"];

    colors = colors.sort().reverse();
    var res = "";
    for(var i in colors)
        res += '<div class="colorPatern" style="background-color:' + colors[i] + '"></div>';

    $("#colorPalete").append(res);

    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        document.cookie = cname + "=" + cvalue + ";expires="+ d.toUTCString();
    }

    function getCookie(cname) {
        var name = cname + "=",
            ca = document.cookie.split(';'),
            i, c;
        for(i = 0; i <ca.length; i++) {
            c = ca[i];
            while (c.charAt(0)==' ')
                c = c.substring(1);
            if (c.indexOf(name) == 0)
                return c.substring(name.length,c.length);
        }
        return "";
    }

    function closeDialog(){
        //$("#modalWindow > div").each((e) => $(e).hide());
        
        $("#modalWindow > div").each(function(){
            $(this).hide();
        });
        $("#colorPalete").undelegate();
        $("#modalWindow").hide();
        $("canvas").removeClass("blur");
    }

    function showOptions(){
        $("#modalWindow ").find("#optionsForm").show();
        $("#modalWindow").show();
        $("canvas").addClass("blur");
    }

    function showColors(){
        $("#modalWindow ").find("#colorPalete").show();
        $("#modalWindow").show();
        $("canvas").addClass("blur");
    }

    function showSharingOptions(){
        $("#modalWindow ").find("#shareForm").show();
        $("#modalWindow").show();
        $("canvas").addClass("blur");
    }

    function showSavingOptions(){
        document.getElementById("idImageWidth").value = canvas.width;
        document.getElementById("idImageHeight").value = canvas.height;
        var div, el, counter = 0, parent = document.getElementById("layersSavionOptions");
        parent.innerHTML = "";
        each(Scene.layers, (a) => {
            div = document.createElement("div");

            el = document.createElement("input");
            el.setAttribute("type", "checkbox");
            el.setAttribute("class", "layerVisibility");
            el.setAttribute("id", "layer" + counter);
            el.setAttribute("checked", "true");

            el.setAttribute("name", a.title);
            div.appendChild(el);

            el = document.createElement("label");
            el.setAttribute("for", "layer" + (counter++));
            el.appendChild(document.createTextNode(a.title));
            div.appendChild(el);
            parent.appendChild(div);
        });

        $("#modalWindow ").find("#saveForm").show();
        $("#modalWindow").show();
        $("canvas").addClass("blur");
    }

    function serializeOptionsData(){
    }

    function serializeSaveData(){
        var getValueIfExist = (e, val = false) => e ? (e.type == "checkbox" ? e.checked : e.value) : val;
        var result = [];
        result["width"] = getValueIfExist(document.getElementById("idImageWidth"), canvas.width);
        result["height"] = getValueIfExist(document.getElementById("idImageHeight"), canvas.height);
        result["name"] = getValueIfExist(document.getElementById("idImageName"));

        result["format"] = document.getElementById("idImageFormat");
        result["format"] = result["format"].options && 
                           result["format"].selectedIndex && 
                           result["format"].options[result["format"].selectedIndex] && 
                           result["format"].options[result["format"].selectedIndex].value;

        var layerCheckboxes = document.getElementsByClassName("layerVisibility");
        result["selectedLayers"] = [];
        each(layerCheckboxes, e => e.checked && result["selectedLayers"].push(e.name));
        /*
        for(var i=0 ; i<layerCheckboxes.length ; i++)
            if(layerCheckboxes[i].checked)
                result["selectedLayers"].push(layerCheckboxes[i].name);
        */

        //TODO načítať farbu pozadia
        result["background"] = KEYWORD_TRANSPARENT;

        processImageData(result);
    }

    function processImageData(data){
        data["name"] = isString(data["name"]) || "desktopScreen";
        data["format"] = isString(data["format"]) || IMAGE_FORMAT_PNG;
        data["width"] = data["width"] || canvas.width;
        data["height"] = data["height"] || canvas.height;
        data["selectedLayers"] = data["selectedLayers"] || [];


        /*
         * velký canvas kde sa všetko nakreslí
         */
        var ca = document.createElement("canvas");
        ca.width = canvas.width;
        ca.height = canvas.height;
        var resContext = ca.getContext("2d");

        /*
         * prekreslí pozadie ak je nastavene a nieje priesvitné
         */
        if(isString(data["background"]) && data["background"] !== KEYWORD_TRANSPARENT){
            doRect({
                x: 0,
                y: 0,
                width: ca.width,
                height: ca.height,
                fillColor: data["background"],
                ctx: resContext
            });
        }

        /*
         * Vykreslí vrstvy určené na vykresleni
         */
        for(var i in data["selectedLayers"]){
            if(data["selectedLayers"].hasOwnProperty(i)){
                //TODO vykreslenie jednotlivých vrstiev
            }
        }

        //TODO toto zakomentovať lebo to prekresluje všetko
        resContext.drawImage(canvas, 0, 0);

        /*
         * malý canvas kde sa prekreslí velký canvas
         */
        var resCanvas =  document.createElement("canvas");
        resCanvas.width = data["width"];
        resCanvas.height = data["height"];
        resContext = resCanvas.getContext("2d");
        resContext.drawImage(ca, 0, 0, resCanvas.width, resCanvas.height);


        /*
         * uloženie súboru
         */
        Files.saveImage(data["name"], resCanvas.toDataURL(data["format"]));
        closeDialog();
    }

    function serializeShareData(){
        var getValueIfExists = e => e ? (e.type == "checkbox" ? e.checked : e.value) : false;
        var result = {};
        result["realTime"] = getValueIfExists(document.getElementById("idRealtimeSharing"));
        result["maxWatchers"] = getValueIfExists(document.getElementById("idMaxWatchers"));
        result["password"] = getValueIfExists(document.getElementById("idSharingPassword"));
        result["detailMovement"] = getValueIfExists(document.getElementById("idDetailMovement"));

        result["shareMenu"] = getValueIfExists(document.getElementById("idShareMenu"));
        result["sharePaints"] = getValueIfExists(document.getElementById("idSharePaints"));
        result["shareObjects"] = getValueIfExists(document.getElementById("idShareObjects"));
        closeDialog();
        Sharer.startShare(result);
    }

    function pickUpColor(func, thisArg){
        var T;
        if (arguments.length > 1)
            T = thisArg;
        $("#colorPalete").delegate(".colorPatern", "click", function(){
            $(".selected").removeClass("selected");
            func.call(T, $(this).addClass("selected").css("backgroundColor"));
            closeDialog();
            draw();
        });
        showColors();
    }

    function getText(text, position, size, func, thisArg){
        var T, x = $(document.createElement("INPUT"));

        if (arguments.length > 1)
            T = thisArg;

        x.attr({
            type: "text",
            value: text,
            id: "staticInput"
        }).css({
            left: position.x + 'px',
            top: position.y + 'px',
            width: size.x,
            height: size.y,
            fontSize: size.y * 0.6
        }).blur(function(){
            func.call(T, x.val());
            x.remove();
            draw();
        }).keyup(function(e){
            if(e.keyCode == ENTER_KEY){
                x.onblur = false;
                func.call(T, x.val());
                x.remove();
                draw();
            }
        }).appendTo("body");
        x.select().focus();
    }

    function openFile() {
        console.log(f);
        f.click();
    }

    if(typeof SharerManager !== "undefined")
        Sharer = new SharerManager();

    

    //window.open(Creator._view._canvas.toDataURL("image/png"), '_blank');
</script>